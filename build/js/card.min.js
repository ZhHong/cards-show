/**
 * Created by Moudi on 2017/2/16.
 */
'use strict';var _createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,'value'in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}var GameCard=function(){function a(b){for(var c in _classCallCheck(this,a),b)this[c]=b[c];this.isDead=!1,this.isNew=!1}return _createClass(a,[{key:'attackP',value:function attackP(b,c){var d=Math.random(),e=parseInt(this.attack*(d<this.CRI?this.CS:1)*(1-b.defense/(400+b.defense))),f=b.health-e;return notice('<span class="name">'+b.name+'</span>\u53D7\u5230<span class="name">'+this.name+'</span>\u7684\u653B\u51FB,\u9020\u6210<span class="num">'+e+'</span>\u70B9\u4F24\u5BB3'),b.health=Math.round(f),0>=b.health&&(b.health=0,b.isDead=!0,notice('<span class="name">'+b.name+'</span>\u5DF2\u7ECF\u9635\u4EA1\u3002')),shake(c,'left'),d<this.CRI?'\u66B4\u51FB\uFF01':'ok'}}]),a}(),$cardC=$('#card-container'),$cs=$('li',$cardC),vm=null,showArr=[],gachaArr=[],attackerArr=[],defenderArr=[],showN=0,s2Vm=null,g0Vm=null,lastSection=$('#section0'),flipCount={count:0,obj:[],canFlip:!0},probability={r:.6,sr:.3,ssr:.1},rArr=[[],[],[]],$attackers=void 0,$defenders=void 0,defen=[],attac=[];window.onload=init;function init(){$('#section0').style.display='flex',window.location.hash='nav=s0',ctxCtrl.init('dot'),document.cookie.split('=').some(function(a){return'isRead'==a})||(objCtrl.fadeIn($('.dialog-bg')[0]),objCtrl.fadeIn($('.dialog')[0])),initVue(),initEvent(),initData(),setTimeout(function(){objCtrl.fadeOut($('.loader')[0])},500)}function initVue(){vm=new Vue({el:'#card-container',data:{list:showArr},methods:{spread:function spread(){isSpread?cm.reset():cm.transform2d(cm.right)}},watch:{list:function list(){setTimeout(function(){$cardC=$('#card-container'),$cs=$('li',$cardC);0==$cs.length||objCtrl.addCard($cs[$cs.length-1])},0)}}}),s2Vm=new Vue({el:'#s2',data:{list:gachaArr}}),g0Vm=new Vue({el:'#game-table-0',data:{aList:attackerArr,dList:defenderArr},watch:{aList:function aList(){objCtrl.fadeIn($('.attacker-wrapper')[0]),objCtrl.fadeIn($('.defender-wrapper')[0])}}})}function initEvent(){var a=$('#return-main-nav'),b=$('nav')[0],c=$('.main-nav')[0],d=$('li',c);$('.btn1',$('.dialog')[0])[0].onclick=function(){document.cookie='isRead=true',objCtrl.fadeOut($('.dialog-bg')[0]),objCtrl.fadeOut($('.dialog')[0])};for(var e=0;e<d.length;e++)d[e].index=e;c.addEventListener('click',function(f){if('A'==f.target.nodeName){for(var g=0;g<d.length;g++)d[g].classList.remove('active');f.target.parentNode.classList.add('active'),window.location.hash='nav=s'+f.target.parentNode.index,objCtrl.moveOut(b),objCtrl.fadeIn(a)}}),a.onclick=function(){objCtrl.fadeOut(this),objCtrl.moveIn(b)}}function initData(){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var b,c,a=cardsData[Symbol.iterator]();!(_iteratorNormalCompletion=(b=a.next()).done);_iteratorNormalCompletion=!0)c=b.value,c.rarity.r?rArr[0].push(c):c.rarity.sr?rArr[1].push(c):c.rarity.ssr&&rArr[2].push(c)}catch(d){_didIteratorError=!0,_iteratorError=d}finally{try{!_iteratorNormalCompletion&&a.return&&a.return()}finally{if(_didIteratorError)throw _iteratorError}}}window.onhashchange=function(){var a=window.location.hash.substring(1).split('=')[1],b={s0:function s0(){objCtrl.fadeOut(lastSection,function(){reset(),$('#section0').style.display='flex',lastSection=$('#section0'),changeBackground(3,function(){$('#dot').style.background='linear-gradient(to bottom, #9cc2c9, #8468b8)'})})},s1:function s1(){objCtrl.fadeOut(lastSection,function(){reset(),$('#section1').style.display='flex',lastSection=$('#section1'),changeBackground(0,function(){initS1Event()})})},s2:function s2(){objCtrl.fadeOut(lastSection,function(){reset(),$('#section2').style.display='flex',lastSection=$('#section2'),changeBackground(1,function(){function c(){$('#section2').classList.add('ready-1'),d.removeEventListener(getAnimationend(),c),initS2Event()}$('#section2').classList.add('ready');var d=$('img',$('.touch')[0])[1];d.addEventListener(getAnimationend(),c)})})},s3:function s3(){objCtrl.fadeOut(lastSection,function(){reset(),$('#game-table-0').style.display='flex',lastSection=$('#game-table-0'),changeBackground(3,function(){initG0Event()})})},s4:function s4(){objCtrl.fadeOut(lastSection,function(){reset(),$('#game-table-1').style.display='flex',lastSection=$('#game-table-1'),changeBackground(2,function(){flipGame.init()})})}};if('function'!=typeof b[a])throw'Invalid action.';return b[a]()};var flipGame={MAX_CARD:18,MAX_CARD_LINE:6,_imgArr:[],init:function(){var b=this;this._setArr();var a=$('#gt');a.innerHTML='';for(var _loop=function(c){setTimeout(function(){var d=document.createElement('li'),e=document.createElement('div'),f=document.createElement('div');e.className='front',e.style.backgroundImage='url(./src/img/game/'+b._imgArr[c]+'.png)',f.className='back',d.appendChild(e),d.appendChild(f),d.style.top=140*Math.floor(c/b.MAX_CARD_LINE)+'px',d.style.left=100*(c%b.MAX_CARD_LINE)+'px',d.gameData=b._imgArr[c],d.isFlip=!1,d.onclick=function(){if(flipCount.canFlip&&!this.isFlip&&(flipCount.count++,flipCount.obj.push(this),this.classList.add('flipped'),d.isFlip=!0,2==flipCount.count))if(flipCount.obj[0].gameData===flipCount.obj[1].gameData){for(var g=0;g<flipCount.obj.length;g++)flipCount.obj[g].classList.add('right');flipCount.count=0,flipCount.obj=[]}else flipCount.canFlip=!1,setTimeout(function(){for(var h=0;h<flipCount.obj.length;h++)flipCount.obj[h].classList.remove('flipped'),flipCount.obj[h].isFlip=!1;flipCount.canFlip=!0,flipCount.count=0,flipCount.obj=[]},600)},a.appendChild(d),objCtrl.fadeIn($('li',a)[$('li',a).length-1])},100*c)};i<this.MAX_CARD;i++)_loop(0)},_setArr:function _setArr(){this._imgArr=[];for(var c,a=this.MAX_CARD/2,b=0;b<a;b++)c=Math.floor(22*Math.random()+1),-1==this._imgArr.indexOf(c)?this._imgArr.push(c):b--;return this._imgArr=this._imgArr.concat(this._imgArr),this._imgArr.sort(function(){return Math.random()-.5}),this._imgArr}};function initS1Event(){var a=$('#click-navigation'),b=$('.addNum',a)[0],c=$('.btn',a)[0];objCtrl.fadeIn(a);for(var d=0;17>d;d++)setTimeout(function(){showArr.push(new GameCard(cardsData[Math.floor(Math.random()*cardsData.length)]))},150*d+600);c.onclick=function(){var e=parseInt(b.value);isNaN(e)?alert('\u8BF7\u8F93\u5165\u6709\u6548\u6570\u5B57\uFF01'):100<e?alert('\u8F93\u5165\u6570\u5B57\u8FC7\u5927\uFF01\u8BF7\u68C0\u67E5'):cm.reset(function(){b.value='';for(var f=0;f<e;f++)setTimeout(function(){showArr.push(new GameCard(cardsData[Math.floor(Math.random()*cardsData.length)]))},150*f+600)})}}function initS2Event(){function a(h){if(f[h].isShow=!0,d=!0,0==h){f[h].classList.add('show-card'),f[h].style.display='block';var l=function(){d=!1,f[h].removeEventListener(getAnimationend(),l)};return void f[h].addEventListener(getAnimationend(),l)}var m=f[h-1];if(m.isShow){m.classList.remove('show-card'),m.classList.add('fade-out-card'),m.isShow=!1;var n=function(){m.style.display='',m.classList.remove('fade-out-card'),f[h].classList.add('show-card'),f[h].style.display='block';var o=function(){d=!1,f[h].removeEventListener(getAnimationend(),o)};f[h].addEventListener(getAnimationend(),o),m.removeEventListener(getAnimationend(),n)};m.addEventListener(getAnimationend(),n)}}function b(){for(var _loop2=function(h){var h=f[h];h.style.left=-110*(f.length/2-h)+50+'%',setTimeout(function(){objCtrl.fadeIn(h)},100*h)};i<f.length;i++)_loop2(0)}function c(h){for(var _loop3=function(l){var l=h[l],m=g[l];l.addEventListener('mouseenter',function(o){if(!d){o.stopPropagation();var p=function(r){r.stopPropagation();var s={x:r.clientX-l.getBoundingClientRect().left,y:r.clientY-l.getBoundingClientRect().top},t=20*((l.clientWidth/2-s.x)/(l.clientWidth/2)),u=20*((s.y-l.clientHeight/2)/(l.clientHeight/2)),v=Math.atan2(-(s.x-l.clientWidth/2),-(l.clientHeight/2-s.y));v=180*v/Math.PI,20<t&&(t=20),20<u&&(u=20),l.style.transform='rotateX('+u+'deg) rotateY('+t+'deg) scale3d(1.08, 1.08, 1.08)',m.style.background='linear-gradient('+v+'deg, rgba(255, 255, 255, 0.7) 0%, rgba(255, 255, 255, 0) 80%)'};l.addEventListener('mousemove',p,!0);var q=function(){o.stopPropagation(),l.style.transform='none',m.style.background='',l.removeEventListener('mousemove',p),l.removeEventListener('mouseout',q)};l.addEventListener('mouseout',q,!0)}},!0)};i<h.length;i++)_loop3(0)}var d=!1;gacha(gachaArr,5);var e=$('.book')[0],f=$('.wrapper',$('#s2')),g=$('.shadow',$('#s2'));e.onclick=function(){showN=0,f=$('.wrapper',$('#s2')),g=$('.shadow',$('#s2')),c(f,g),$('#section2').classList.add('gacha'),$('.background')[0].children[1].classList.add('brightness');var h=$('img',$('.touch')[0])[1],l=function(){$('#s2').style.display='block',$('.touch')[0].style.display='none',h.removeEventListener(getAnimationend(),l),a(showN),document.onclick=function(m){if(m.preventDefault(),showN++,showN>=f.length){var n=f[f.length-1];n.classList.remove('show-card'),n.classList.add('fade-out-card'),n.isShow=!1;var o=function(){n.style.display='',n.classList.remove('fade-out-card'),n.removeEventListener(getAnimationend(),o),b(),document.onclick=null,showN=0};return void n.addEventListener(getAnimationend(),o)}a(showN)}};h.addEventListener(getAnimationend(),l)}}function initG0Event(){document.onmousedown=function(a){a.preventDefault()},$('#dot').style.background='linear-gradient(to bottom, rgb(167, 228, 239), rgb(245, 159, 167))',attackerArr.splice(0,attackerArr.length),defenderArr.splice(0,defenderArr.length),gacha(attackerArr,3),gacha(defenderArr,3),$attackers=$('li',$('.attacker')[0]),$defenders=$('li',$('.defender')[0]),notice('\u53CC\u51FB\u5C4F\u5E55\u5F00\u59CB\u6E38\u620F'),document.ondblclick=function(){notice('\u6E38\u620F\u5F00\u59CB'),attackerRound(!0),document.ondblclick=null}}function changeBackground(a,b){for(var _ret4,c=$('.background')[0].children,_loop4=function(d){if(d==a)return'continue';var d=c[d];d.className='',setTimeout(function(){d.style.display='none'},1e3)};i<c.length;i++)_ret4=_loop4(0),'continue'===_ret4;c[a].style.display='',setTimeout(function(){c[a].className='showIn','function'==typeof b&&b()},1e3)}function reset(){var a=$('.wrapper',$('#s2'));showArr.splice(0,showArr.length),$('#section2').className='',$('#gt').innerHTML='',$('.touch')[0].style.display='block',$('#s2').style.display='none',$('#s2').innerHTML='',document.onclick=null;for(var c,b=0;b<a.length;b++)c=a[b],a[b].classList.remove('show-card'),c.style.display='';gachaArr.splice(0,gachaArr.length),$('.attacker-wrapper')[0].style.display='',$('.defender-wrapper')[0].style.display='',$('.notice')[0].innerHTML=''}function gacha(a,b){for(var d,c=0;c<b;c++)d=Math.random(),d>=1-probability.r?a.push(new GameCard(rArr[0][Math.floor(Math.random()*rArr[0].length)])):d>=probability.ssr&&d<probability.sr+probability.ssr?a.push(new GameCard(rArr[1][Math.floor(Math.random()*rArr[1].length)])):d<probability.ssr&&a.push(new GameCard(rArr[2][Math.floor(Math.random()*rArr[2].length)]));return a}function attackerRound(a){if(!checkDead()){if(!a){for(var b=0;b<$attackers.length;b++)$attackers[b].onmousedown=null;return void setTimeout(function(){notice('\u654C\u65B9\u653B\u51FB\u56DE\u5408'),setTimeout(function(){defenderAi()},500)},500)}setTimeout(function(){notice('\u6211\u65B9\u653B\u51FB\u56DE\u5408')},500);for(var c=!1,_loop5=function(d){var d=$attackers[d],e=null;d.index=d,d.onmousedown=function(g){if(!c&&!attackerArr[d.index].isDead){g.preventDefault();var h=d.getBoundingClientRect(),l={x:d.offsetLeft,y:d.offsetTop},m={x:g.clientX-h.left-d.offsetLeft,y:g.clientY-h.top-d.offsetTop};d.classList.add('dragging'),document.onmousemove=function(n){e=null;var o={x:n.clientX-h.left,y:n.clientY-h.top},p=o.x-m.x,q=o.y-m.y;d.style.left=p+'px',d.style.top=q+'px';for(var r=0;r<$defenders.length;r++)$defenders[r].index=r;for(var t,s=0;s<$defenders.length;s++)t=$defenders[s],mt.mouseCollisionDetection(n,t)?!defenderArr[t.index].isDead&&t.classList.add('defense'):t.classList.remove('defense')},document.onmouseup=function(n){for(var p,o=0;o<$defenders.length;o++)p=$defenders[o],mt.mouseCollisionDetection(n,p)&&!defenderArr[p.index].isDead&&(e=p);e?(e.classList.remove('defense'),attackerArr[d.index].attackP(defenderArr[e.index],e),attackerRound(!1),c=!0,lMove(d,{left:l.x,top:l.y},300,'easeOut',function(){c=!1})):(c=!0,lMove(d,{left:l.x,top:l.y},300,'easeOut',function(){c=!1})),d.classList.remove('dragging'),document.onmousemove=document.onmouseup=null}}}};_i3<$attackers.length;_i3++)_loop5(0)}}function notice(a){var b=$('.notice')[0],c=document.createElement('li');c.innerHTML=a,b.insertBefore(c,b.children[0]),b.children[0].classList.add('show')}function defenderAi(){var a=Math.floor(Math.random()*defen.length),b=Math.floor(Math.random()*attac.length),c=$defenders[defen[a].index],d=$attackers[attac[b].index],e={x:c.offsetLeft,y:c.offsetTop},f={x:c.getBoundingClientRect().left,y:c.getBoundingClientRect().top},g={x:d.getBoundingClientRect().left,y:d.getBoundingClientRect().top};lMove(c,{top:g.y-f.y+e.y,left:g.x-f.x+e.x},200,'easeIn',function(){defen[a].attackP(attac[b],d),lMove(c,{top:e.y,left:e.x},200,'easeOut'),attackerRound(!0)})}function checkDead(){attac=[],defen=[];for(var a=0;a<attackerArr.length;a++){var b=attackerArr[a],c=defenderArr[a];b.index=c.index=a,b.isDead||attac.push(b),c.isDead||defen.push(c)}return 0==attac.length?(notice('\u6E38\u620F\u7ED3\u675F\uFF0C\u9632\u5B88\u65B9\u83B7\u80DC\uFF01'),!0):!(0!=defen.length)&&(notice('\u6E38\u620F\u7ED3\u675F\uFF0C\u653B\u51FB\u65B9\u83B7\u80DC\uFF01'),!0)};
var lastOrigin="50% 90%",isSpread=false;var cm={reset:function e(t){$cardC=$("#card-container");$cs=$("li",$cardC);var n=0;var r=function e(){if(typeof t==="function")t()};if(!isSpread){r();return}var a=function e(t){var a=$cs[t];a.style.transition="500ms";a.style.transform="none";a.style.transformOrigin=lastOrigin;var i=function e(){a.style.transition="none";isSpread=false;a.removeEventListener(getTransitionend(),e);n++;if(n==$cs.length){r()}};a.addEventListener(getTransitionend(),i)};for(var i=0;i<$cs.length;i++){a(i)}return true},transform2d:function e(t){t=t||this.defaultSettings;this.reset(function(){var e=function e(n){var r=$cs[n];var a=Math.floor($cs.length/2);var i=t.center?n<=a?(a-n)*-(t.range/2)/a:(n-a)*(t.range/2)/a:t.range/$cs.length*n+t.range/$cs.length;var o=t.translate||0;if(t.direction=="left"){i=-i;o=-o}o=t.center?n<=a?(a-n)*-(o/2)/a:(n-a)*(o/2)/a:o/$cs.length*n;r.style.transformOrigin=lastOrigin=t.origin.x+"% "+t.origin.y+"%";r.style.transition=t.speed+"ms "+t.easing+" transform";r.style.transform="translate("+o+"px) rotate("+i+"deg)";var s=function e(){r.style.transition="none";isSpread=true;r.removeEventListener(getTransitionend(),e);return r};r.addEventListener(getTransitionend(),s)};for(var n=0;n<$cs.length;n++){e(n)}})},nextCard:function e(){this.reset(function(){var e=$cs[$cs.length-1];e.classList.add("next-animation");var t=function t(){e.classList.remove("next-animation");$cardC.insertBefore(e,$cardC.children[0]);e.removeEventListener(getAnimationend(),t);return e};e.addEventListener(getAnimationend(),t)})},prevCard:function e(){this.reset(function(){var e=$cs[0];e.classList.add("prev-animation");var t=function t(){e.classList.remove("prev-animation");$cardC.appendChild(e);e.removeEventListener(getAnimationend(),t);return e};e.addEventListener(getAnimationend(),t)})},defaultSettings:{speed:500,easing:"ease-out",range:10,translate:300,direction:"right",origin:{x:50,y:90},center:false},right:{speed:500,easing:"ease-out",range:90,direction:"right",origin:{x:50,y:100},center:true,translate:60},left:{speed:500,easing:"ease-out",range:90,direction:"left",origin:{x:50,y:100},center:true,translate:60},horizontalSpread:{speed:500,easing:"ease-out",range:100,direction:"right",origin:{x:50,y:200},center:true},rightSpread:{speed:500,easing:"ease-out",range:20,direction:"right",origin:{x:50,y:200},center:false,translate:300},leftSpread:{speed:500,easing:"ease-out",range:20,direction:"left",origin:{x:50,y:200},center:false,translate:300},rotate360:{speed:500,easing:"ease-out",range:360,direction:"left",origin:{x:50,y:90},center:false},rotate330:{speed:500,easing:"ease-out",range:330,direction:"left",origin:{x:50,y:100},center:true}};var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}return function(t,n,r){if(n)e(t.prototype,n);if(r)e(t,r);return t}}();function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}var dots=[],canvas=null,ctx=null,W=null,H=null,options={cW:window.innerWidth,cH:window.innerHeight,numDot:100,radDot:3,dotColor:"rgba(255, 255, 255, .7)",lineDist:70,lineColor:["rgba(255, 255, 255, .4)","rgba(246, 170, 207, .4)","rgba(246, 71, 82, .4)"],vxRange:1,vyRange:1};var Practicle=function(){function e(t,n){_classCallCheck(this,e);this.x=0;this.y=0;this.vx=0;this.vy=0;this.radius=n;this.color=t}_createClass(e,[{key:"draw",value:function e(t){t.save();t.translate(this.x,this.y);t.fillStyle=this.color;t.strokeStyle=this.color;t.beginPath();t.arc(0,0,this.radius,0,Math.PI*2,false);t.closePath();t.fill();t.restore()}},{key:"move",value:function e(){this.x+=this.vx;this.y+=this.vy;if(this.x+this.radius>W){this.x=W-this.radius;this.vx*=-1}else if(this.x-this.radius<0){this.x=this.radius;this.vx*=-1}if(this.y+this.radius>H){this.y=H-this.radius;this.vy*=-1}else if(this.y-this.radius<0){this.y=this.radius;this.vy*=-1}}},{key:"drawLine",value:function e(t){var n=t.x-this.x,r=t.y-this.y,a=Math.sqrt(n*n+r*r);if(a<options.lineDist){ctx.save();ctx.strokeStyle=options.lineColor[1];ctx.beginPath();ctx.moveTo(this.x,this.y);ctx.lineTo(t.x,t.y);ctx.closePath();ctx.stroke();ctx.restore()}}}]);return e}();var ctxCtrl={init:function e(t){canvas=document.getElementById(t);ctx=canvas.getContext("2d");W=options.cW;H=options.cH;canvas.width=options.cW;canvas.height=options.cH;if(!window.requestAnimationFrame){window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return setTimeout(e,20)}}this.initDots();this.update()},initDots:function e(){for(var t=0;t<options.numDot;t++){var n=new Practicle(options.dotColor,options.radDot);n.x=parseInt(Math.random()*W.toFixed(1));n.y=parseInt(Math.random()*H.toFixed(1));n.vx=Math.random()*options.vxRange;n.vy=Math.random()*options.vyRange;dots.push(n)}},update:function e(){ctx.clearRect(0,0,W,H);dots.forEach(function(e){e.move();e.draw(ctx)});for(var t=0;t<options.numDot-1;t++){var n=dots[t];for(var r=t+1;r<options.numDot;r++){var a=dots[r];n.drawLine(a)}}window.requestAnimationFrame(ctxCtrl.update)}};window.onresize=function(){canvas.width=W=window.innerWidth;canvas.height=H=window.innerHeight};function lMove(e,t,n,r,a){var i={};var o=(new Date).getTime();if(typeof r=="function"){a=r;r="linear"}else{r=r||"linear"}for(var s in t){i[s]={};i[s].startS=parseFloat(getComputedStyle(e)[s]);i[s].move=t[s]-i[s].startS}clearInterval(e.timer);e.timer=setInterval(function(){var t=(new Date).getTime()-o;if(t>=n){t=n}for(var s in i){var c=parseFloat(getComputedStyle(e)[s]);var l=Tween[r](t,i[s].startS,i[s].move,n);if(s=="opacity"){e.style[s]=l}else{e.style[s]=l+"px"}}if(t>=n){clearInterval(e.timer);if(typeof a=="function"){a&&a()}}},20)}var Tween={linear:function(e,t,n,r){return n*e/r+t},easeIn:function(e,t,n,r){return n*(e/=r)*e+t},easeOut:function(e,t,n,r){return-n*(e/=r)*(e-2)+t}};